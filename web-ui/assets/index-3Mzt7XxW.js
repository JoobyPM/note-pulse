(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=o(n);fetch(n.href,a)}})();const ee=new Set,s={accessToken:null,refreshToken:null,notesById:new Map,noteOrder:[],currentNoteId:null,isLoading:!1,nextCursor:null,limit:30,q:"",sort:"created_at",order:"desc",totalCount:null,ws:null,reconnectTimerId:null,backoffDelay:0,refreshingPromise:null,refreshFailures:0,refreshBlockedUntil:0,lastFailure:0,accessExp:0,ACCESS_THRESHOLD_SEC:300},p=t=>{Object.assign(s,t),ee.forEach(e=>e(s))},Ne=t=>(ee.add(t),()=>ee.delete(t)),R=t=>{s.notesById.has(t.id)||s.noteOrder.unshift(t.id),s.notesById.set(t.id,t),p({notesById:s.notesById,noteOrder:s.noteOrder})},Ee=t=>{const e=s.noteOrder.indexOf(t);e>-1&&(s.noteOrder.splice(e,1),s.notesById.delete(t),p({notesById:s.notesById,noteOrder:s.noteOrder,currentNoteId:s.currentNoteId===t?null:s.currentNoteId}))},Z=()=>{s.noteOrder.length=0,s.notesById.clear(),p({notesById:s.notesById,noteOrder:s.noteOrder,nextCursor:null})},Ae=()=>{s.noteOrder.length=0,s.notesById.clear(),p({notesById:s.notesById,noteOrder:s.noteOrder,currentNoteId:null,nextCursor:null,limit:30,q:"",sort:"created_at",order:"desc",totalCount:null})},te="http://localhost:8080",Ce=te+"/api/v1",Pe=(te.startsWith("https")?"wss://":"ws://")+te.replace(/^https?:\/\//,"")+"/ws/notes/stream",Me=t=>{try{const e=t.replace(/-/g,"+").replace(/_/g,"/"),o=e.padEnd(e.length+(4-e.length%4)%4,"=");return atob(o)}catch{return console.warn("Token decoding failed - invalid token format"),null}},Te=t=>{try{const e=Me(t.split(".")[1]);return e?JSON.parse(e).exp*1e3:0}catch{return console.warn("Token parsing failed"),0}},ue=(t,e,o)=>{try{t.setItem(e,o)}catch(r){console.warn(`Failed to set ${e} in storage:`,r)}},fe=(t,e)=>{try{t.removeItem(e)}catch(o){console.warn(`Failed to remove ${e} from storage:`,o)}},De=()=>{const t=sessionStorage.getItem("notePulseAccess")||null,e=localStorage.getItem("notePulseRefresh")||null,o=t?Te(t):0;let r=300;if(t&&o>0){const n=Math.max(0,(o-Date.now())/1e3);r=Math.max(30,Math.floor(n*.5))}p({accessToken:t,refreshToken:e,accessExp:o,ACCESS_THRESHOLD_SEC:r})},Be=(t,e)=>{const o=Te(t);ue(sessionStorage,"notePulseAccess",t);const r=Math.max(0,(o-Date.now())/1e3),a=Math.max(30,Math.floor(r*.5)),i={accessToken:t,accessExp:o,ACCESS_THRESHOLD_SEC:a};e&&(i.refreshToken=e,ue(localStorage,"notePulseRefresh",e)),p(i)},He=()=>{fe(sessionStorage,"notePulseAccess"),fe(localStorage,"notePulseRefresh"),p({accessToken:null,refreshToken:null,accessExp:0})},se=async()=>{s.accessToken&&(Date.now()+s.ACCESS_THRESHOLD_SEC*1e3<s.accessExp||await ae())},ae=()=>{if(Date.now()<s.refreshBlockedUntil)throw new Error("refresh back-off");if(s.refreshingPromise)return s.refreshingPromise;if(!s.refreshToken)throw new Error("no refresh token");const t=(async()=>{const e=new AbortController,o=setTimeout(()=>e.abort(),1e4);try{const r=await fetch(Ce+"/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:s.refreshToken}),signal:e.signal});if(r.status===401)throw await Y(),location.hash="#/sign-in",new Error("refresh token expired");if(!r.ok)throw new Error("refresh failed");const n=await r.json();Be(n.token,n.refresh_token),p({refreshFailures:0,refreshBlockedUntil:0,refreshingPromise:null})}finally{clearTimeout(o),p({refreshingPromise:null})}})().catch(e=>{if(e.message==="refresh token expired")throw e;const o=Date.now();o-s.lastFailure>3e5&&p({refreshFailures:0});const r=s.refreshFailures+1,n=Math.min(1e3*2**(r-1),3e4);throw p({refreshFailures:r,lastFailure:o,refreshBlockedUntil:Date.now()+n}),e});return p({refreshingPromise:t}),t},S=async(t,e={},o=!1)=>{await se().catch(()=>{});const r=new AbortController,n={headers:{"Content-Type":"application/json",...e.headers||{}},...e};s.accessToken&&(n.headers.Authorization="Bearer "+s.accessToken),n.signal=r.signal;const a=await fetch(Ce+t,n);if(a.status===401&&!o)try{return await ae(),n.headers.Authorization="Bearer "+s.accessToken,S(t,n,!0)}catch{throw await Y(),location.hash="#/sign-in",new Error("Session expired")}if(!a.ok){let i="Error "+a.status;try{const l=await a.json();l.error&&(i=l.error)}catch{console.error("Error parsing JSON response:",a)}throw new Error(i)}return a.status===204?null:a.json()},qe=30,O={signUp:(t,e)=>S("/auth/sign-up",{method:"POST",body:JSON.stringify({email:t,password:e})}),signIn:(t,e)=>S("/auth/sign-in",{method:"POST",body:JSON.stringify({email:t,password:e})}),signOut:()=>S("/auth/sign-out",{method:"POST",body:JSON.stringify({refresh_token:s.refreshToken})}),listNotes:(t,e=qe)=>{if(typeof t=="object"&&t!==null){const o=t,r=[];o.limit!==void 0&&o.limit>=1&&o.limit<=100&&r.push(`limit=${o.limit}`),o.cursor&&r.push(`cursor=${o.cursor}`),o.q&&o.q.length>=1&&o.q.length<=256&&r.push(`q=${encodeURIComponent(o.q)}`),o.sort&&["created_at","updated_at","title"].includes(o.sort)&&r.push(`sort=${o.sort}`),o.order&&["asc","desc"].includes(o.order)&&r.push(`order=${o.order}`);const n=r.length>0?"?"+r.join("&"):"";return S("/notes"+n)}else{const o=t;return S("/notes"+(o?`?cursor=${o}&limit=${e}`:`?limit=${e}`))}},createNote:t=>S("/notes",{method:"POST",body:JSON.stringify(t)}),updateNote:(t,e)=>S(`/notes/${t}`,{method:"PATCH",body:JSON.stringify(e)}),deleteNote:t=>S(`/notes/${t}`,{method:"DELETE"}),me:()=>S("/me")},j=async t=>{if(s.ws&&(s.ws.readyState===WebSocket.OPEN||s.ws.readyState===WebSocket.CONNECTING))return;if(Date.now()<s.refreshBlockedUntil){setTimeout(()=>j(t),s.refreshBlockedUntil-Date.now()+100);return}if(await se().catch(()=>{}),!s.accessToken)return;s.ws&&(s.ws.onclose=null,s.ws.onmessage=null,s.ws.onerror=null,s.ws.close());const e=new WebSocket(`${Pe}?token=${s.accessToken}`);s.reconnectTimerId&&(clearTimeout(s.reconnectTimerId),p({reconnectTimerId:null,backoffDelay:0})),e.onopen=()=>{p({ws:e})},e.onmessage=t,e.onerror=()=>pe(()=>j(t)),e.onclose=async o=>{if(p({ws:null}),[1008,1006,4001].includes(o.code)){try{await ae()}catch{}setTimeout(()=>j(t),500)}else pe(()=>j(t))},p({ws:e})},pe=t=>{const e=s.backoffDelay?Math.min(s.backoffDelay*2,3e4):1e3,o=e*.1*(2*Math.random()-1),r=Math.max(100,e+o),n=setTimeout(t,r);p({backoffDelay:e,reconnectTimerId:n})},Se=()=>{s.reconnectTimerId&&clearTimeout(s.reconnectTimerId),s.ws&&(s.ws.onclose=null,s.ws.onmessage=null,s.ws.onerror=null,s.ws.close()),p({ws:null,reconnectTimerId:null,backoffDelay:0})},Y=async()=>{He(),Se()};/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var k=function(){return k=Object.assign||function(e){for(var o,r=1,n=arguments.length;r<n;r++){o=arguments[r];for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(e[a]=o[a])}return e},k.apply(this,arguments)},$e=function(){function t(e){this.options=e,this.listeners={}}return t.prototype.on=function(e,o){var r=this.listeners[e]||[];this.listeners[e]=r.concat([o])},t.prototype.triggerEvent=function(e,o){var r=this,n=this.listeners[e]||[];n.forEach(function(a){return a({target:r,event:o})})},t}(),H;(function(t){t[t.Add=0]="Add",t[t.Remove=1]="Remove"})(H||(H={}));var Fe=function(){function t(){this.notifications=[]}return t.prototype.push=function(e){this.notifications.push(e),this.updateFn(e,H.Add,this.notifications)},t.prototype.splice=function(e,o){var r=this.notifications.splice(e,o)[0];return this.updateFn(r,H.Remove,this.notifications),r},t.prototype.indexOf=function(e){return this.notifications.indexOf(e)},t.prototype.onUpdate=function(e){this.updateFn=e},t}(),L;(function(t){t.Dismiss="dismiss",t.Click="click"})(L||(L={}));var he={types:[{type:"success",className:"notyf__toast--success",backgroundColor:"#3dc763",icon:{className:"notyf__icon--success",tagName:"i"}},{type:"error",className:"notyf__toast--error",backgroundColor:"#ed3d3d",icon:{className:"notyf__icon--error",tagName:"i"}}],duration:2e3,ripple:!0,position:{x:"right",y:"bottom"},dismissible:!1},je=function(){function t(){this.notifications=[],this.events={},this.X_POSITION_FLEX_MAP={left:"flex-start",center:"center",right:"flex-end"},this.Y_POSITION_FLEX_MAP={top:"flex-start",center:"center",bottom:"flex-end"};var e=document.createDocumentFragment(),o=this._createHTMLElement({tagName:"div",className:"notyf"});e.appendChild(o),document.body.appendChild(e),this.container=o,this.animationEndEventName=this._getAnimationEndEventName(),this._createA11yContainer()}return t.prototype.on=function(e,o){var r;this.events=k(k({},this.events),(r={},r[e]=o,r))},t.prototype.update=function(e,o){o===H.Add?this.addNotification(e):o===H.Remove&&this.removeNotification(e)},t.prototype.removeNotification=function(e){var o=this,r=this._popRenderedNotification(e),n;if(r){n=r.node,n.classList.add("notyf__toast--disappear");var a;n.addEventListener(this.animationEndEventName,a=function(i){i.target===n&&(n.removeEventListener(o.animationEndEventName,a),o.container.removeChild(n))})}},t.prototype.addNotification=function(e){var o=this._renderNotification(e);this.notifications.push({notification:e,node:o}),this._announce(e.options.message||"Notification")},t.prototype._renderNotification=function(e){var o,r=this._buildNotificationCard(e),n=e.options.className;return n&&(o=r.classList).add.apply(o,n.split(" ")),this.container.appendChild(r),r},t.prototype._popRenderedNotification=function(e){for(var o=-1,r=0;r<this.notifications.length&&o<0;r++)this.notifications[r].notification===e&&(o=r);if(o!==-1)return this.notifications.splice(o,1)[0]},t.prototype.getXPosition=function(e){var o;return((o=e==null?void 0:e.position)===null||o===void 0?void 0:o.x)||"right"},t.prototype.getYPosition=function(e){var o;return((o=e==null?void 0:e.position)===null||o===void 0?void 0:o.y)||"bottom"},t.prototype.adjustContainerAlignment=function(e){var o=this.X_POSITION_FLEX_MAP[this.getXPosition(e)],r=this.Y_POSITION_FLEX_MAP[this.getYPosition(e)],n=this.container.style;n.setProperty("justify-content",r),n.setProperty("align-items",o)},t.prototype._buildNotificationCard=function(e){var o=this,r=e.options,n=r.icon;this.adjustContainerAlignment(r);var a=this._createHTMLElement({tagName:"div",className:"notyf__toast"}),i=this._createHTMLElement({tagName:"div",className:"notyf__ripple"}),l=this._createHTMLElement({tagName:"div",className:"notyf__wrapper"}),u=this._createHTMLElement({tagName:"div",className:"notyf__message"});u.innerHTML=r.message||"";var f=r.background||r.backgroundColor;if(n){var m=this._createHTMLElement({tagName:"div",className:"notyf__icon"});if((typeof n=="string"||n instanceof String)&&(m.innerHTML=new String(n).valueOf()),typeof n=="object"){var c=n.tagName,h=c===void 0?"i":c,g=n.className,x=n.text,T=n.color,M=T===void 0?f:T,_=this._createHTMLElement({tagName:h,className:g,text:x});M&&(_.style.color=M),m.appendChild(_)}l.appendChild(m)}if(l.appendChild(u),a.appendChild(l),f&&(r.ripple?(i.style.background=f,a.appendChild(i)):a.style.background=f),r.dismissible){var I=this._createHTMLElement({tagName:"div",className:"notyf__dismiss"}),de=this._createHTMLElement({tagName:"button",className:"notyf__dismiss-btn"});I.appendChild(de),l.appendChild(I),a.classList.add("notyf__toast--dismissible"),de.addEventListener("click",function(V){var q,D;(D=(q=o.events)[L.Dismiss])===null||D===void 0||D.call(q,{target:e,event:V}),V.stopPropagation()})}a.addEventListener("click",function(V){var q,D;return(D=(q=o.events)[L.Click])===null||D===void 0?void 0:D.call(q,{target:e,event:V})});var Oe=this.getYPosition(r)==="top"?"upper":"lower";return a.classList.add("notyf__toast--"+Oe),a},t.prototype._createHTMLElement=function(e){var o=e.tagName,r=e.className,n=e.text,a=document.createElement(o);return r&&(a.className=r),a.textContent=n||null,a},t.prototype._createA11yContainer=function(){var e=this._createHTMLElement({tagName:"div",className:"notyf-announcer"});e.setAttribute("aria-atomic","true"),e.setAttribute("aria-live","polite"),e.style.border="0",e.style.clip="rect(0 0 0 0)",e.style.height="1px",e.style.margin="-1px",e.style.overflow="hidden",e.style.padding="0",e.style.position="absolute",e.style.width="1px",e.style.outline="0",document.body.appendChild(e),this.a11yContainer=e},t.prototype._announce=function(e){var o=this;this.a11yContainer.textContent="",setTimeout(function(){o.a11yContainer.textContent=e},100)},t.prototype._getAnimationEndEventName=function(){var e=document.createElement("_fake"),o={MozTransition:"animationend",OTransition:"oAnimationEnd",WebkitTransition:"webkitAnimationEnd",transition:"animationend"},r;for(r in o)if(e.style[r]!==void 0)return o[r];return"animationend"},t}(),Re=function(){function t(e){var o=this;this.dismiss=this._removeNotification,this.notifications=new Fe,this.view=new je;var r=this.registerTypes(e);this.options=k(k({},he),e),this.options.types=r,this.notifications.onUpdate(function(n,a){return o.view.update(n,a)}),this.view.on(L.Dismiss,function(n){var a=n.target,i=n.event;o._removeNotification(a),a.triggerEvent(L.Dismiss,i)}),this.view.on(L.Click,function(n){var a=n.target,i=n.event;return a.triggerEvent(L.Click,i)})}return t.prototype.error=function(e){var o=this.normalizeOptions("error",e);return this.open(o)},t.prototype.success=function(e){var o=this.normalizeOptions("success",e);return this.open(o)},t.prototype.open=function(e){var o=this.options.types.find(function(a){var i=a.type;return i===e.type})||{},r=k(k({},o),e);this.assignProps(["ripple","position","dismissible"],r);var n=new $e(r);return this._pushNotification(n),n},t.prototype.dismissAll=function(){for(;this.notifications.splice(0,1););},t.prototype.assignProps=function(e,o){var r=this;e.forEach(function(n){o[n]=o[n]==null?r.options[n]:o[n]})},t.prototype._pushNotification=function(e){var o=this;this.notifications.push(e);var r=e.options.duration!==void 0?e.options.duration:this.options.duration;r&&setTimeout(function(){return o._removeNotification(e)},r)},t.prototype._removeNotification=function(e){var o=this.notifications.indexOf(e);o!==-1&&this.notifications.splice(o,1)},t.prototype.normalizeOptions=function(e,o){var r={type:e};return typeof o=="string"?r.message=o:typeof o=="object"&&(r=k(k({},r),o)),r},t.prototype.registerTypes=function(e){var o=(e&&e.types||[]).slice(),r=he.types.map(function(n){var a=-1;o.forEach(function(l,u){l.type===n.type&&(a=u)});var i=a!==-1?o.splice(a,1)[0]:{};return k(k({},n),i)});return r.concat(o)},t}();const B=(t,e)=>{t&&(t.textContent=e||"")},_e=/^#[0-9a-f]{6}$/i,oe=/^#[0-9a-f]{3}$/i,U=t=>_e.test(t)||oe.test(t),z=t=>{if(!t)return t;if(_e.test(t))return t.slice(0,7);if(oe.test(t)){const[,e,o,r]=t.match(oe);return`#${e}${e}${o}${o}${r}${r}`}return t},d=(t,e=document)=>e.querySelector(t),Ue=(t,e="")=>{const o=document.createElement(t);return e&&(o.className=e),o},K=t=>{var e;return((e=t.querySelector("[data-note-id]"))==null?void 0:e.offsetHeight)+8||80};let re;const ze=()=>{re=new Re({duration:3e3,position:{x:"center",y:"top"}})},b=(t,e="error")=>e==="error"?re.error(t):re.success(t),We=`
#pulseCircle { fill:#3b82f6; transform-origin:60px 60px; }
#notePaper   { fill:#ffffff; }
#noteFold    { fill:#dbeafe; }
@keyframes pulse {
  0% { transform:scale(1); opacity:.9; }
  50%{ transform:scale(1.5); opacity:.3; }
 100%{ transform:scale(2); opacity:0; }
}
.pulse-active #pulseCircle { animation:pulse 1s ease-out forwards; }`,Ve=()=>{if(document.getElementById("notePulseLogoStyles"))return;const t=document.createElement("style");t.id="notePulseLogoStyles",t.textContent=We,document.head.appendChild(t)},Xe=()=>'<img id="notePulseLogo" src="logo.svg" class="h-8 w-8" alt="NotePulse">',ne=()=>{const t=document.getElementById("notePulseLogo");t&&(t.classList.remove("pulse-active"),t.offsetWidth,t.classList.add("pulse-active"))};let A=[],X=null,C=null,N=null,E=80,y=null;const J=new Map;let $=null;const Je=()=>{let t=!1;try{t=localStorage.getItem("notePulseDarkMode")==="true"}catch(o){console.warn("Failed to read dark mode preference:",o)}t=!t;try{localStorage.setItem("notePulseDarkMode",t.toString())}catch(o){console.warn("Failed to save dark mode preference:",o)}t?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark");const e=d("#dark-toggle");e&&e.setAttribute("aria-pressed",t.toString()),b(t?"🌙 Dark mode on":"☀️ Light mode on","success")},Ye=()=>{let t=!1;try{t=localStorage.getItem("notePulseDarkMode")==="true"}catch(o){console.warn("Failed to read dark mode preference:",o)}const e=d("#dark-toggle");e&&e.setAttribute("aria-pressed",t.toString())},v=(t,e,o)=>{t.addEventListener(e,o);const r=()=>t.removeEventListener(e,o);return A.push(r),r},ie=()=>{X&&(clearTimeout(X),X=null),C&&(C.disconnect(),C=null),N&&(N=null),A.forEach(t=>t()),A=[]};var ve;const ge=(ve=d("#noteCardTpl"))==null?void 0:ve.content;var xe;const me=(xe=d("#skeletonCardTpl"))==null?void 0:xe.content;var we;const ye=(we=d("#emptyStateTpl"))==null?void 0:we.content;var ke;const be=(ke=d("#editorPlaceholderTpl"))==null?void 0:ke.content,F=[[60,"s"],[60,"m"],[24,"h"],[30,"d"],[12,"mo"]],Ie=t=>{const e=Date.now(),o=Math.floor((e-new Date(t).getTime())/1e3);if(o<5)return"just now";let r=o,n=0;for(;n<F.length&&r>=F[n][0];)r=Math.floor(r/F[n][0]),n++;return r+F[Math.min(n,F.length-1)][1]+" ago"},Le=(t,e=!1)=>{if(!ge)return null;const o=ge.cloneNode(!0).firstElementChild;e&&o.classList.add("selected");const r=t.color&&U(t.color)?z(t.color):"#3b82f6";return o.querySelector(".note-color-bar").style.background=r,B(o.querySelector(".note-title"),t.title),B(o.querySelector(".note-body"),t.body),B(o.querySelector(".note-updated"),Ie(t.updated_at)),o.dataset.noteId=t.id,o.setAttribute("role","option"),o.setAttribute("aria-label",t.title),o.setAttribute("aria-selected",e.toString()),o.setAttribute("tabindex","0"),o.querySelector(".note-title").id=`nt-${t.id}`,o.addEventListener("click",()=>P(t)),o.addEventListener("keydown",n=>{(n.key==="Enter"||n.key===" ")&&(n.preventDefault(),P(t))}),o},Ke=(t,e,o=!1)=>{o?t.classList.add("selected"):t.classList.remove("selected");const r=e.color&&U(e.color)?z(e.color):"#3b82f6";t.querySelector(".note-color-bar").style.background=r,B(t.querySelector(".note-title"),e.title),B(t.querySelector(".note-body"),e.body),B(t.querySelector(".note-updated"),Ie(e.updated_at)),t.dataset.noteId=e.id,t.setAttribute("aria-label",e.title),t.setAttribute("aria-selected",o.toString()),t.querySelector(".note-title").id=`nt-${e.id}`},Ge=()=>me?me.cloneNode(!0).firstElementChild:null,Ze=()=>ye?ye.cloneNode(!0).firstElementChild:null,Qe=()=>be?be.cloneNode(!0).firstElementChild:null,et=()=>{addEventListener("hashchange",W),W()},W=()=>{const t=location.hash||(s.accessToken?"#/app":"#/sign-in");if(!s.accessToken&&t.startsWith("#/app")){location.hash="#/sign-in";return}if(s.accessToken&&t.startsWith("#/sign-")){location.hash="#/app";return}if(t==="#/sign-in")tt();else if(t==="#/sign-up")ot();else if(t.startsWith("#/app")){const e=t.split("/"),o=e.length>2?e[2]:null;nt(o)}else location.hash=s.accessToken?"#/app":"#/sign-in"},tt=()=>{ie(),d("#root").innerHTML=`
    <div class="flex items-center justify-center h-full">
      <form id="sign-in-form" class="max-w-sm w-full bg-white dark:bg-gray-800 p-6 rounded-xl shadow">
        <h2 class="text-2xl font-semibold mb-4 text-center text-gray-900 dark:text-gray-100">Sign in</h2>
        <input type="email"    id="email"    placeholder="Email"    class="w-full mb-3 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded" autocomplete="email" required>
        <input type="password" id="password" placeholder="Password" class="w-full mb-4 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded" autocomplete="current-password" required minlength="6">
        <button class="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Sign in</button>
        <p class="text-sm text-center mt-4 text-gray-600 dark:text-gray-400">No account?
          <a href="#/sign-up" class="text-blue-600 underline">Sign up</a>
        </p>
      </form>
    </div>`,v(d("#sign-in-form"),"submit",async t=>{t.preventDefault();try{const e=await O.signIn(t.target.email.value,t.target.password.value);p({accessToken:e.token,refreshToken:e.refresh_token}),location.hash="#/app",W()}catch{b("Invalid credentials or sign-in failed")}})},ot=()=>{ie(),d("#root").innerHTML=`
    <div class="flex items-center justify-center h-full">
      <form id="sign-up-form" class="max-w-sm w-full bg-white dark:bg-gray-800 p-6 rounded-xl shadow">
        <h2 class="text-2xl font-semibold mb-4 text-center text-gray-900 dark:text-gray-100">Sign up</h2>
        <input type="email"    id="su-email"    placeholder="Email"    class="w-full mb-3 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded" autocomplete="email" required>
        <input type="password" id="su-password" placeholder="Password" class="w-full mb-4 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded" autocomplete="new-password" required minlength="6">
        <button class="w-full py-2 bg-green-600 text-white rounded hover:bg-green-700">Create account</button>
        <p class="text-sm text-center mt-4 text-gray-600 dark:text-gray-400">Have an account?
          <a href="#/sign-in" class="text-blue-600 underline">Sign in</a>
        </p>
      </form>
    </div>`,v(d("#sign-up-form"),"submit",async t=>{t.preventDefault();try{const e=await O.signUp(t.target["su-email"].value,t.target["su-password"].value);p({accessToken:e.token,refreshToken:e.refresh_token}),location.hash="#/app",W()}catch{b("Error creating account")}})},rt=t=>{const{type:e,note:o}=JSON.parse(t.data);switch(e){case"created":{for(let n=0;n<s.noteOrder.length;n++){const a=s.noteOrder[n];if(a.startsWith("tmp-")){const i=s.notesById.get(a);if(i&&i.title===o.title&&i.body===o.body){s.noteOrder.splice(n,1),s.notesById.delete(a);break}}}const r=!s.notesById.has(o.id);R(o),w(),r&&(ne(),b("Note created","success"),P(o,!0));break}case"updated":{s.notesById.has(o.id)&&(R(o),w(),s.currentNoteId===o.id&&P(o,!0),ne());break}case"deleted":{Ee(o.id),w(),s.currentNoteId===o.id&&ce(),b("Note deleted","error");break}}},nt=(t=null)=>{ie(),Se(),Ve(),d("#root").innerHTML=`
    <div class="flex h-full">
      <aside class="w-80 border-r border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 overflow-hidden">
        <div class="flex items-center justify-between p-4">
          <div class="flex items-center space-x-2">
            ${Xe()}
            <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">My Notes</h2>
          </div>
          <div class="flex items-center space-x-2">
            <button id="dark-toggle" class="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="Toggle dark mode" aria-pressed="false">
              <svg class="w-4 h-4 text-gray-600 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path class="dark:hidden" d="M10 2L13.09 8.26L20 9L14 14.74L15.18 21.02L10 17.77L4.82 21.02L6 14.74L0 9L6.91 8.26L10 2Z"/>
                <path class="hidden dark:block" d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
              </svg>
            </button>
            <button id="sign-out" class="px-2 py-1 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded text-sm hover:bg-gray-300 dark:hover:bg-gray-500">Sign out</button>
            <button id="new-note" class="p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700" aria-label="Create note" disabled>+</button>
          </div>
        </div>
        <div class="px-4 pb-3 border-b border-gray-200 dark:border-gray-700">
          <div class="flex items-center space-x-2 mb-2">
            <input 
              type="search" 
              id="search-input" 
              placeholder="Search…" 
              class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded"
              autocomplete="off"
            >
            <div class="relative">
              <button id="sort-button" class="px-3 py-2 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center space-x-1" aria-haspopup="menu" aria-expanded="false" aria-label="Sort by Created (descending)">
                <span id="sort-label">Created</span>
                <svg id="sort-order" class="w-4 h-4 inline" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" style="pointer-events: none;">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
              </button>
              <div id="sort-dropdown" class="absolute top-full right-0 mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded shadow-lg z-10 hidden min-w-max" role="menu" aria-labelledby="sort-button">
                <button class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitemradio" aria-checked="true" data-sort="created_at">Created</button>
                <button class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitemradio" aria-checked="false" data-sort="updated_at">Updated</button>
                <button class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitemradio" aria-checked="false" data-sort="title">Title</button>
              </div>
            </div>
          </div>
          <div id="notes-count" class="text-sm text-gray-500 dark:text-gray-400" aria-live="polite" aria-atomic="true"></div>
        </div>
        <div id="note-list" class="note-list overflow-y-auto h-[calc(100%-120px)] p-2 space-y-2" role="listbox" aria-label="Notes" tabindex="0"></div>
      </aside>
      <main class="flex-1 p-6 overflow-y-auto">
        <div id="editor" class="h-full flex flex-col"></div>
      </main>
    </div>`,v(d("#new-note"),"click",ct),v(d("#dark-toggle"),"click",Je),Ye(),st(),it(),at(),v(d("#sign-out"),"click",async()=>{try{await O.signOut()}catch{}await Y(),location.hash="#/sign-in",W(),b("Signed out","success")});const e=Ne(n=>{const a=d("#new-note");a&&(n.ws&&n.ws.readyState===WebSocket.OPEN?a.removeAttribute("disabled"):a.setAttribute("disabled",""))}),o=setTimeout(()=>{const n=d("#new-note");n&&n.hasAttribute("disabled")&&n.removeAttribute("disabled")},1e3);A.push(e),A.push(()=>clearTimeout(o)),Ae(),ce();const r=sessionStorage.getItem("notePulseLastNote");p({isLoading:!0}),w(),le(!0).then(()=>{const n=t||r;if(n){const a=s.notesById.get(n);a?P(a,!0):t&&(location.hash="#/app")}return j(rt)}).catch(n=>{b(n.message),w()})},st=()=>{const t=d("#search-input"),e=d("#sort-button"),o=d("#sort-dropdown"),r=d("#sort-label"),n=d("#sort-order"),a=d("#notes-count");if(!t||!e||!o)return;let i=null;v(t,"input",c=>{i&&clearTimeout(i),i=setTimeout(()=>{const h=c.target.value.trim();h!==s.q&&(p({q:h}),Z(),Q())},300)}),v(t,"keydown",c=>{c.key==="Escape"&&(c.target.value="",c.target.focus(),s.q!==""&&(p({q:""}),Z(),Q()))}),v(e,"click",c=>{c.stopPropagation();const h=o.classList.contains("hidden");o.classList.toggle("hidden"),e.setAttribute("aria-expanded",h?"true":"false")}),v(document,"click",()=>{o.classList.contains("hidden")||(o.classList.add("hidden"),e.setAttribute("aria-expanded","false"))}),o.querySelectorAll("[data-sort]").forEach(c=>{v(c,"click",h=>{const g=h.target.dataset.sort,x=s.sort,T=s.order;let M="desc";g===x&&(M=T==="desc"?"asc":"desc"),p({sort:g,order:M}),u(),Z(),Q();const _=d("#note-list");_&&(_.scrollTop=0),o.classList.add("hidden")})});const u=()=>{const c={created_at:"Created",updated_at:"Updated",title:"Title"};if(r&&(r.textContent=c[s.sort]||"Created"),e){const g=c[s.sort]||"Created",x=s.order==="asc"?"ascending":"descending";e.setAttribute("aria-label",`Sort by ${g} (${x})`)}const h=o==null?void 0:o.querySelectorAll("[data-sort]");h&&h.forEach(g=>{const x=g.dataset.sort===s.sort;g.setAttribute("aria-checked",x.toString())}),n&&(s.order==="asc"?n.innerHTML='<path d="M5 15l7-7 7 7"/>':n.innerHTML='<path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>')},f=()=>{if(a)if(s.totalCount!==null){const c=s.noteOrder.length,h=s.totalCount;a.textContent=`${c} of ${h} notes`}else a.textContent="0 of 0 notes"},m=Ne(()=>{f()});A.push(m),A.push(()=>{i&&clearTimeout(i)}),u(),f()},Q=async()=>{p({isLoading:!0}),w();try{await le(!0)}catch(t){t.message.includes("400")?b("Invalid filter settings","error"):t.message.includes("401")||t.message.includes("403")||b("Error loading notes","error")}},at=()=>{const t=d("#note-list");t&&v(t,"keydown",e=>{if(e.key==="ArrowDown"||e.key==="ArrowUp"){e.preventDefault();const o=Array.from(t.querySelectorAll("[data-note-id]"));if(o.length===0)return;const r=o.findIndex(i=>i.dataset.noteId===s.currentNoteId);let n;e.key==="ArrowDown"?n=r<0?0:(r+1)%o.length:n=r<=0?o.length-1:r-1;const a=o[n];if(a){const i=a.dataset.noteId,l=s.notesById.get(i);l&&(P(l),a.scrollIntoView({block:"nearest",behavior:"smooth"}))}}else e.key==="Enter"||e.key})},it=()=>{const t=d("#note-list");t&&(y=t,N=document.createElement("div"),N.id="list-end",N.style.height="1px",C=new IntersectionObserver(e=>{e.forEach(o=>{o.isIntersecting&&s.nextCursor&&!s.isLoading&&le().catch(r=>b(r.message))})},{rootMargin:"100px"}),window.ResizeObserver&&($=new ResizeObserver(()=>{y&&s.noteOrder.length>0&&(E=K(y),G())}),$.observe(t)),v(t,"scroll",lt),A.push(()=>{C&&(C.disconnect(),C=null),$&&($.disconnect(),$=null),N&&(N=null),J.clear(),y=null}))},lt=()=>{!y||s.noteOrder.length===0||(E===80&&(E=K(y)),G())},G=()=>{if(!y||s.isLoading||s.noteOrder.length===0)return;E===80&&s.noteOrder.length>0&&(E=K(y));const t=y.scrollTop,e=y.clientHeight,o=s.noteOrder.length,r=Math.max(0,Math.floor(t/E)-10),n=Math.min(o,Math.ceil((t+e)/E)+10),a=s.noteOrder.slice(r,n);if(C&&N&&C.unobserve(N),Array.from(y.querySelectorAll("[data-note-id]")).forEach(f=>{const m=f.dataset.noteId;m&&J.set(m,f)}),y.innerHTML="",r>0){const f=document.createElement("div");f.style.height=`${r*E}px`,y.appendChild(f)}const l=document.createElement("div");a.forEach(f=>{const m=s.notesById.get(f);if(m){const c=s.currentNoteId===m.id;let h=J.get(f);h?(Ke(h,m,c),J.delete(f)):h=Le(m,c),h&&(h.style.marginBottom="8px",l.appendChild(h))}}),y.appendChild(l);const u=o-n;if(u>0){const f=document.createElement("div");f.style.height=`${u*E}px`,y.appendChild(f)}s.nextCursor&&N&&(y.appendChild(N),C&&C.observe(N))},le=async(t=!1)=>{if(!(!t&&s.isLoading)){t&&p({isLoading:!0});try{const e={limit:s.limit,cursor:t?null:s.nextCursor,q:s.q||void 0,sort:s.sort,order:s.order};Object.keys(e).forEach(r=>{e[r]===void 0&&delete e[r]});const o=await O.listNotes(e);(o.notes||[]).filter(Boolean).forEach(r=>{s.notesById.has(r.id)||(s.noteOrder.push(r.id),s.notesById.set(r.id,r))}),p({isLoading:!1,nextCursor:o.next_cursor||null,totalCount:o.total_count!==void 0?o.total_count:s.totalCount,notesById:s.notesById,noteOrder:s.noteOrder}),w(t),t&&E===80&&y&&s.noteOrder.length>0&&setTimeout(()=>{E=K(y),G()},100)}catch(e){throw p({isLoading:!1}),e}}},w=(t=!1)=>{const e=d("#note-list");if(s.isLoading){e.textContent="";for(let o=0;o<6;o++){const r=Ge();r&&e.appendChild(r)}return}if(s.noteOrder.length===0){e.textContent="";const o=Ze();o&&e.appendChild(o);return}y&&s.noteOrder.length>0?G():(e.textContent="",s.noteOrder.forEach(o=>{const r=s.notesById.get(o);if(r){const n=s.currentNoteId===r.id,a=Le(r,n);a&&e.appendChild(a)}})),t&&e&&(e.scrollTop=0)},ce=()=>{const t=d("#editor");t.textContent="";const e=Qe();e&&t.appendChild(e);try{sessionStorage.removeItem("notePulseLastNote")}catch(o){console.warn("Failed to remove notePulseLastNote from storage:",o)}document.title="NotePulse",p({currentNoteId:null})},P=(t,e=!1)=>{p({currentNoteId:t.id});try{sessionStorage.setItem("notePulseLastNote",t.id)}catch(l){console.warn("Failed to set notePulseLastNote in storage:",l)}location.hash!==`#/app/${t.id}`&&(location.hash=`#/app/${t.id}`);const o=t.title?t.title.replace(/[<>&"']/g,""):"Untitled";document.title=`${o} - NotePulse`;const r=d("#note-list").querySelectorAll("[data-note-id]");for(const l of r)l.dataset.noteId===t.id?(l.classList.add("selected"),l.setAttribute("aria-selected","true")):(l.classList.remove("selected"),l.setAttribute("aria-selected","false"));const n=d("#note-list");n&&n.setAttribute("aria-activedescendant",`nt-${t.id}`);const a=d("#editor");a.textContent="";const i=()=>{a.textContent="";const l=document.createElement("input");l.id="note-title",l.className="mb-3 text-2xl font-semibold outline-none w-full bg-transparent text-gray-900 dark:text-gray-100",l.value=t.title;const u=document.createElement("textarea");u.id="note-body",u.rows=15,u.className="flex-1 resize-none w-full outline-none border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 p-3 rounded mb-4",u.value=t.body;const f=document.createElement("div");f.className="flex items-center mb-4 space-x-3";const m=document.createElement("label");m.className="text-sm",m.textContent="Color:";const c=document.createElement("input");c.id="note-color",c.type="color",c.value=t.color&&U(t.color)?z(t.color):"#3b82f6",c.className="h-8 w-8 border-0",c.setAttribute("aria-label","Note color picker"),f.appendChild(m),f.appendChild(c);const h=document.createElement("div");h.className="space-x-3";const g=document.createElement("button");g.id="save-note",g.className="px-4 py-2 bg-blue-600 text-white rounded",g.textContent="Save";const x=document.createElement("button");x.id="delete-note",x.className="px-4 py-2 bg-red-600 text-white rounded",x.textContent="Delete",x.setAttribute("aria-label","Delete note"),h.appendChild(g),h.appendChild(x),a.appendChild(l),a.appendChild(u),a.appendChild(f),a.appendChild(h),requestAnimationFrame(()=>l.focus()),v(g,"click",async()=>{const T=c.value;if(!c.checkValidity()||T&&!U(T)){b("Invalid color");return}const M={...t},_={title:l.value,body:u.value,color:T&&z(T)};g.disabled=!0,Object.assign(t,_,{updated_at:new Date().toISOString()}),R(t),w();try{const I=await O.updateNote(t.id,_);R(I.note),w(),(I.note.title!==l.value||I.note.body!==u.value||I.note.color!==c.value)&&P(I.note,!0),b("Saved","success"),ne()}catch{Object.assign(t,M),R(t),w(),P(t,!0),b("Error saving note")}finally{g.disabled=!1}}),v(x,"click",async()=>{Ee(t.id),w(),ce();try{await O.deleteNote(t.id)}catch{b("Error deleting note")}})};if(e)i();else{const l=document.createElement("h2");l.className="text-2xl font-semibold mb-3 text-gray-500",l.textContent="Loading note…";const u=document.createElement("div");u.className="flex-1 animate-pulse rounded bg-gray-200",u.style.minHeight="300px",a.appendChild(l),a.appendChild(u),X=setTimeout(i,200)}},ct=()=>{const t=document.activeElement,e=Ue("div","modal-overlay");e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.setAttribute("aria-labelledby","modal-title"),e.innerHTML=`
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 w-96">
      <h3 id="modal-title" class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">New note</h3>
      <input id="new-title" placeholder="Title" class="w-full mb-3 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded">
      <textarea id="new-body" rows="6" placeholder="Body" class="w-full mb-3 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded"></textarea>
      <input id="new-color" type="color" value="#3b82f6" class="mb-4 h-10 w-10 p-0 border-0" aria-label="Note color picker">
      <div class="flex justify-end space-x-2">
        <button id="cancel" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
        <button id="create" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Create</button>
      </div>
    </div>`,document.body.appendChild(e);const o=e.querySelectorAll("input, textarea, button"),r=o[0],n=o[o.length-1],a=[],i=u=>{u.key==="Escape"?l():u.key==="Tab"&&(u.shiftKey?document.activeElement===r&&(u.preventDefault(),n.focus()):document.activeElement===n&&(u.preventDefault(),r.focus()))},l=()=>{e.remove(),document.removeEventListener("keydown",i),a.forEach(u=>u()),t==null||t.focus()};document.addEventListener("keydown",i),r==null||r.focus(),a.push(v(d("#cancel",e),"click",()=>{l()})),a.push(v(d("#create",e),"click",async()=>{const u=d("#new-color",e),f=u.value||null;if(f&&(!u.checkValidity()||!U(f))){b("Invalid color");return}const m={title:d("#new-title",e).value,body:d("#new-body",e).value,color:f&&z(f)};l();const c="tmp-"+Date.now(),h={...m,id:c,updated_at:new Date().toISOString()};s.noteOrder.unshift(c),s.notesById.set(c,h),w(!0);try{await O.createNote(m);const g=s.noteOrder.indexOf(c);g>-1&&(s.noteOrder.splice(g,1),s.notesById.delete(c)),w(!0)}catch{const g=s.noteOrder.indexOf(c);g>-1&&(s.noteOrder.splice(g,1),s.notesById.delete(c)),w(!0),b("Failed to create note")}}))},dt=()=>{try{localStorage.getItem("notePulseDarkMode")==="true"?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}catch(t){console.warn("Failed to read dark mode preference:",t)}};(async()=>(dt(),ze(),De(),await se().catch(()=>{}),sessionStorage.getItem("notePulseAccess")&&O.me().catch(()=>Y()),et()))();
